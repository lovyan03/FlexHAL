# FlexHAL アーキテクチャ設計

FlexHALは、柔軟性と拡張性を重視した3層構造のハードウェア抽象化レイヤー（HAL）です。この文書では、FlexHALの基本設計思想と各層の役割について説明します。

## 3層構造の概要

FlexHALは以下の3つの層から構成されています：

```
┌─────────────────────────────────┐
│           アプリケーション          │
└─────────────────┬───────────────┘
                  │
┌─────────────────┼───────────────┐
│              FlexHAL             │
├─────────────────┼───────────────┤
│    フレームワーク層 (Framework)    │
├─────────────────┼───────────────┤
│      RTOS層 (Real-Time OS)       │
├─────────────────┼───────────────┤
│    プラットフォーム層 (Platform)    │
└─────────────────┼───────────────┘
                  │
┌─────────────────┼───────────────┐
│        ハードウェア / OS          │
│  (ESP32, RP2040, SDL, etc.)     │
└─────────────────────────────────┘
```

## 各層の役割と責任

### 1. プラットフォーム層 (Platform)

プラットフォーム層は、特定のハードウェアやOSに依存する低レベルの機能を抽象化します。

- **役割**：
  - ハードウェア固有の初期化と設定
  - 低レベルのデバイスドライバ
  - メモリ管理
  - 割り込み処理

- **実装例**：
  - ESP32プラットフォーム
  - RP2040プラットフォーム
  - SDLプラットフォーム（デスクトップシミュレーション用）

### 2. RTOS層 (Real-Time OS)

RTOS層は、マルチタスク、同期、タイマーなどのリアルタイムオペレーティングシステム機能を提供します。

- **役割**：
  - タスク管理
  - セマフォ、ミューテックス、キューなどの同期プリミティブ
  - タイマー管理
  - イベント処理

- **実装例**：
  - FreeRTOS実装
  - SDL実装（シミュレーション用）

### 3. フレームワーク層 (Framework)

フレームワーク層は、高レベルの機能とAPIを提供し、アプリケーション開発を簡素化します。

- **役割**：
  - GUIコンポーネント
  - ファイルシステム
  - ネットワーク通信
  - センサーとアクチュエータの抽象化

- **実装例**：
  - ディスプレイドライバ
  - タッチパネル管理
  - ファイルシステムインターフェース
  - ネットワークプロトコル

## 拡張性と移植性

FlexHALの3層構造は、以下の利点を提供します：

1. **モジュール性**：各層は独立して開発・テスト・更新が可能
2. **移植性**：新しいハードウェアプラットフォームをサポートするには、プラットフォーム層のみを実装すれば良い
3. **一貫性**：すべてのプラットフォームで一貫したAPIを提供
4. **テスト容易性**：デスクトップ環境でのシミュレーションが可能

## 実装ガイドライン

FlexHALの各層を実装する際は、以下のガイドラインに従ってください：

1. **依存関係の方向**：上位層は下位層に依存することはできますが、下位層は上位層に依存してはいけません
2. **インターフェース設計**：各層は明確に定義されたインターフェースを通じて通信する
3. **エラー処理**：各層は適切なエラーコードを返し、上位層でエラーを処理できるようにする
4. **リソース管理**：各層は自身が確保したリソースを適切に解放する責任がある

## 実装ファイル構造のルール

FlexHALの実装ファイルは以下のルールに従って整理されています：

### 1. フォルダ構造

```
/impl
  ├─ FlexHAL_Impl.hpp  <- 実装ファイルのエントリポイント
  ├─ internal
  │   └─ platform_detect.h
  ├─ platforms
  │   ├─ desktop
  │   │   └─ impl_includes.h
  │   ├─ esp32
  │   │   └─ impl_includes.h
  │   └─ ...
  ├─ frameworks
  │   ├─ sdl
  │   │   └─ impl_includes.h
  │   └─ ...
  └─ rtos
      ├─ sdl
      │   └─ impl_includes.h
      └─ ...
```

### 2. インクルードのルール

- `.inl` ファイルは直接インクルードせず、エントリポイントとなるヘッダファイルからのみインクルードする
- 各プラットフォーム/フレームワーク/RTOSの `impl_includes.h` ファイルがそのレイヤーに必要な全ての `.inl` ファイルをインクルードする
- `FlexHAL_Impl.hpp` がプラットフォーム検出に基づいて適切な `impl_includes.h` ファイルを選択する

### 3. 実装ファイルの命名規則

機能ごとに一貫した命名規則を採用します：
- `core.inl` - コア機能
- `gpio.inl` - GPIO機能
- `time.inl` - 時間管理機能
- `logger.inl` - ロギング機能

### 4. 依存関係の方向性

- 共通コード（`src` フォルダ）は実装詳細（`impl` フォルダ）に依存しない
- 実装詳細（`impl` フォルダ）は共通インターフェース（`src` フォルダ）に依存する

### 5. 実装の優先順位

1. コア機能（時間管理、ロギング）
2. GPIO、SPI、I2Cなどの周辺機能
3. 高度な機能（ネットワーク、ファイルシステムなど）

## バージョン管理

FlexHALはセマンティックバージョニング（MAJOR.MINOR.PATCH）を採用しています。破壊的変更はMAJORバージョンアップで対応します。バージョン管理はGitのタグとリリースを使用して行います。
